<!--
Farm Dashboard (Vanilla HTML + CSS + JS)
Files included in this single document:

1) index.html            -> the front-end (HTML, CSS, vanilla JS)
2) netlify/functions/notion.js  -> a Netlify serverless function (Node) that proxies requests to Notion API
3) README (below)       -> setup + deployment instructions (Netlify)

IMPORTANT security note:
- Do NOT place your Notion Integration Token directly into client-side code.
- The included serverless function reads the token from environment variables (NOTION_TOKEN) and the database id (NOTION_DB_ID).
- Deploy on Netlify (free). Add the env vars in Netlify site settings.

-->
<!--  

========================================
README
========================================

Overview
--------
This package is a small, secure front-end dashboard in plain HTML/CSS/vanilla JS that reads your Notion "cow database" by calling a serverless proxy. The proxy keeps your Notion integration token secret.

What you get
------------
- An `index.html` (single file) that renders a responsive dashboard, table + simple chart, search and filters, and basic row detail modal.
- A Netlify Function (`netlify/functions/notion.js`) that queries your Notion database and returns simplified JSON for the front-end.

Why a serverless function?
--------------------------
Notion integration tokens are secrets. If you put them in client-side code, anyone can see them. The Netlify Function acts as a secure middleman.

Requirements
------------
- A Notion Integration token (create in Notion Developers and add the integration to your cow database's Share list).
- The Notion Database ID for your cows database.
- A Netlify account (free). We'll deploy by connecting your GitHub repo.

Environment variables to set on Netlify (Site settings -> Build & deploy -> Environment):
- NOTION_TOKEN = <your internal integration token>
- NOTION_DB_ID = <your database id (UUID)>  

Deployment steps (short)
------------------------
1. Create a new GitHub repo and add the `index.html` and `netlify/functions/notion.js` files.
2. Log into Netlify, create a new site from GitHub, choose the repo.
3. In Netlify site settings, set the environment variables `NOTION_TOKEN` and `NOTION_DB_ID`.
4. Deploy. Your front-end will be live at `https://<your-site>.netlify.app`.

API endpoints exposed by the function
------------------------------------
GET /.netlify/functions/notion?op=list
  - Returns an array of simplified cow objects.
GET /.netlify/functions/notion?op=get&id=<page_id>
  - Returns a single page's full simplified object.

Customization
-------------
- If your Notion property names differ (e.g. "Tag" instead of "Tag Number"), edit the mapping in the front-end `mapNotionPage` function.

========================================
index.html
========================================
 -->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farm Tracker — Cows</title>
  <meta name="description" content="Simple farm dashboard: cows, production, and trends (Notion-backed)." />
  <style>
    /* Minimal modern CSS — responsive grid and clean table */
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#60a5fa; --glass: rgba(255,255,255,0.03);
      --radius:12px; --maxw:1100px;
      color-scheme: dark;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#071022 0%, #071827 100%); color:#e6eef8}
    .page{max-width:var(--maxw); margin:28px auto; padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
    .input{background:var(--card);border-radius:10px;padding:8px 12px;border:1px solid rgba(255,255,255,0.03);min-width:180px}
    .btn{background:linear-gradient(90deg,var(--accent),#34d399);border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:900px){.layout{grid-template-columns:1fr} .right-col{order:2}}

    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table thead th{position:sticky;top:0;background:rgba(0,0,0,0.15);backdrop-filter:blur(2px);padding:10px;text-align:left;color:var(--muted);font-weight:600}
    .table tbody tr{border-top:1px solid rgba(255,255,255,0.02)}
    .table td{padding:10px;vertical-align:middle}

    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--glass);font-size:12px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center}
    .modal{width:min(760px,96%);background:#020617;padding:20px;border-radius:12px}

    /* small chart placeholder */
    .chart{height:160px;display:flex;align-items:center;justify-content:center;color:var(--muted)}

    footer{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page">
    <header>
      <div class="logo">FD</div>
      <div>
        <h1>Farm Dashboard — Cows</h1>
        <p class="lead">Live data from your Notion database (read-only). Use the Netlify function to keep your Notion token secret.</p>
      </div>
    </header>

    <div class="controls">
      <input class="input" id="search" placeholder="Search tag / type / notes..." />
      <select id="filterType" class="input">
        <option value="">All types</option>
        <option value="Cow">Cow</option>
        <option value="Heifer">Heifer</option>
        <option value="Bull">Bull</option>
      </select>
      <button class="btn" id="refreshBtn">Refresh</button>
      <button class="btn secondary" id="exportCsv">Export CSV</button>
    </div>

    <div class="layout">
      <main>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <strong>Herd</strong>
            <div class="muted" id="summary">Loading...</div>
          </div>

          <div style="overflow:auto;max-height:560px">
            <table class="table" aria-live="polite">
              <thead>
                <tr>
                  <th>Tag</th>
                  <th>Type</th>
                  <th>Age</th>
                  <th>Latest Milk (L)</th>
                  <th>Last Prod</th>
                  <th>Offspring</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <!-- rows injected by JS -->
              </tbody>
            </table>
          </div>
        </div>

        <footer>
          <div>Tip: To allow edits from the dashboard, implement a secure POST endpoint and add UI forms. Ask me and I'll add it.</div>
        </footer>
      </main>

      <aside class="right-col">
        <div class="card">
          <strong>Production trend</strong>
          <div class="chart" id="chart">(small sparkline)</div>
        </div>
       <!-- Add Cow Button -->
<!-- Add Cow trigger -->
<button id="addCowBtn" class="btn-primary">Add Cow</button>

<!-- Single Modal (overlay hidden by default) -->

<div id="cowModal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card" role="document">

    <div class="modal-header">
      <h3>Add Cow</h3>
      <button id="closeModalBtn" class="btn-close" aria-label="Close">✕</button>
    </div>

    <!-- Camera area: only one of <video> or <img> is visible at a time -->
    <div id="cameraArea">
      <video id="cameraStream" autoplay playsinline></video>
      <img id="photoPreview" alt="Photo preview" class="hidden"/>
    </div>

    <div class="camera-controls">
      <button id="takePhotoBtn" class="btn-primary">Take photo</button>
      <button id="retakeBtn" class="btn-secondary hidden">Retake</button>
      <span id="modalStatus" class="muted" aria-live="polite"></span>
    </div>

    <!-- Form -->
    <form id="cowForm" class="cow-form">
      <label>Tag number
        <input id="tagInput" name="tag" type="text" required autocomplete="off"/>
      </label>

      <label>Gender
        <select id="genderInput" name="gender">
          <option value="">Select</option>
          <option value="Female">Female</option>
          <option value="Male">Male</option>
          <option value="Unknown">Unknown</option>
        </select>
      </label>

      <label>Owner
        <input id="ownerInput" name="owner" type="text" autocomplete="off"/>
      </label>

      <label>Children (comma-separated IDs)
        <input id="childrenInput" name="children" type="text" placeholder="E.g. COW-12, COW-13"/>
      </label>

      <label>Parent (ID)
        <input id="parentInput" name="parent" type="text" placeholder="E.g. COW-01"/>
      </label>

      <div class="form-actions">
        <button type="button" id="cancelBtn" class="btn-secondary">Close</button>
        <button type="submit" id="submitBtn" class="btn-primary">Finish & Add Another</button>
      </div>
    </form>

  </div>
</div>

        <div class="card" style="margin-top:12px">
          <strong>Selected cow</strong>
          <div id="selected">No cow selected. Click a row to view details.</div>
        </div>
      </aside>
    </div>
  </div>
  <script>
    /* Modal + camera logic: clean, robust, minimal dependencies.
   Drop into the bottom of your page (after the modal HTML). */

(() => {
  // Elements
  const addCowBtn = document.getElementById('addCowBtn');
  const cowModal = document.getElementById('cowModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  const cameraStreamEl = document.getElementById('cameraStream');
  const photoPreviewEl = document.getElementById('photoPreview');
  const takePhotoBtn = document.getElementById('takePhotoBtn');
  const retakeBtn = document.getElementById('retakeBtn');
  const modalStatus = document.getElementById('modalStatus');

  const cowForm = document.getElementById('cowForm');
  const tagInput = document.getElementById('tagInput');
  const genderInput = document.getElementById('genderInput');
  const ownerInput = document.getElementById('ownerInput');
  const childrenInput = document.getElementById('childrenInput');
  const parentInput = document.getElementById('parentInput');

  // State
  let stream = null;
  let photoBlob = null;

  // Helpers
  function setStatus(msg, isError = false) {
    modalStatus.textContent = msg || '';
    modalStatus.style.color = isError ? '#fb7185' : '';
  }

  function showModal() {
    cowModal.classList.remove('hidden');
    cowModal.setAttribute('aria-hidden', 'false');
    resetForNewEntry();          // ensure camera ready
    startCamera();
  }

  function hideModal() {
    cowModal.classList.add('hidden');
    cowModal.setAttribute('aria-hidden', 'true');
    stopCamera();
    resetAll();
  }

  // Camera control
  async function startCamera() {
    setStatus('Starting camera...');
    try {
      // prefer environment (rear) camera on mobile
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      cameraStreamEl.srcObject = stream;
      await cameraStreamEl.play().catch(()=>{}); // ignore play promise
      setStatus('');
      // make sure preview is hidden
      photoPreviewEl.classList.add('hidden');
      cameraStreamEl.classList.remove('hidden');
      takePhotoBtn.classList.remove('hidden');
      retakeBtn.classList.add('hidden');
    } catch (err) {
      console.error('Camera error', err);
      setStatus('Camera unavailable', true);
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    try { cameraStreamEl.srcObject = null; } catch(e) {}
  }

  // Take a photo and show preview (replace camera)
  function takePhoto() {
    if (!cameraStreamEl || !cameraStreamEl.videoWidth) {
      setStatus('Camera not ready', true);
      return;
    }
    const w = cameraStreamEl.videoWidth || 1280;
    const h = cameraStreamEl.videoHeight || 720;
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(cameraStreamEl, 0, 0, w, h);

    canvas.toBlob(blob => {
      photoBlob = blob;
      // show preview smaller, replace camera
      photoPreviewEl.src = URL.createObjectURL(blob);
      photoPreviewEl.classList.remove('hidden');
      cameraStreamEl.classList.add('hidden');

      takePhotoBtn.classList.add('hidden');
      retakeBtn.classList.remove('hidden');

      // stop camera to free resources
      stopCamera();
      setStatus('');
    }, 'image/jpeg', 0.85);
  }

  function retake() {
    // discard previous blob & restart camera
    if (photoPreviewEl.src) {
      URL.revokeObjectURL(photoPreviewEl.src);
      photoPreviewEl.src = '';
    }
    photoBlob = null;
    photoPreviewEl.classList.add('hidden');
    cameraStreamEl.classList.remove('hidden');
    takePhotoBtn.classList.remove('hidden');
    retakeBtn.classList.add('hidden');
    setStatus('');
    startCamera();
  }

  // Reset UI for the next cow (keeps modal open)
  function resetForNewEntry() {
    cowForm.reset();
    if (photoPreviewEl.src) { URL.revokeObjectURL(photoPreviewEl.src); photoPreviewEl.src = ''; }
    photoBlob = null;
    photoPreviewEl.classList.add('hidden');
    cameraStreamEl.classList.remove('hidden');
    takePhotoBtn.classList.remove('hidden');
    retakeBtn.classList.add('hidden');
    setStatus('');
  }

  // Full reset when closing modal
  function resetAll(){
    resetForNewEntry();
    setStatus('');
  }

  // Submit handler: prepares payload. Backend call is optional — currently a placeholder.
  async function handleSubmit(e) {
    e.preventDefault();

    // basic validation
    const tag = tagInput.value.trim();
    if (!tag) { setStatus('Tag number required', true); return; }
    if (!photoBlob) { setStatus('Please take a photo', true); return; }

    const payload = {
      tag,
      gender: genderInput.value,
      owner: ownerInput.value,
      children: childrenInput.value,
      parent: parentInput.value,
      // photo will be sent as a Blob in FormData below
    };

    setStatus('Saving...');

    // Example: send as FormData to your backend endpoint (if you have one).
    // If you don't have a backend yet, the code below will simply log the payload and reset UI.
    try {
      // If you have a Netlify function endpoint (addCow), uncomment this block and adjust URL.
      // /*
      const form = document.querySelector('#addCowForm');
      form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const tag = document.querySelector('#tagInput').value;
      const owner = document.querySelector('#ownerInput').value;
      const notes = document.querySelector('#notesInput').value;
      const file = document.querySelector('#imageInput').files[0];
      
      
      await submitCow({ tag, owner, file });
      });

      // --- FRONTEND-ONLY fallback: (no backend) ---
      console.log('Cow save payload (frontend only):', payload);
      console.log('Photo blob:', photoBlob);
      await new Promise(r => setTimeout(r, 350)); // small delay for UX

      // On success: reset form and keep modal open for next cow
      setStatus('Saved ✓');
      resetForNewEntry();
      // restart camera so user can take next photo
      startCamera();

    } catch (err) {
      console.error('Save error', err);
      setStatus('Save failed', true);
    }
  }

  // Event wiring
  addCowBtn?.addEventListener('click', showModal);
  closeModalBtn?.addEventListener('click', hideModal);
  cancelBtn?.addEventListener('click', hideModal);

  // click outside to close
  cowModal?.addEventListener('click', (ev) => {
    if (ev.target === cowModal) hideModal();
  });

  takePhotoBtn?.addEventListener('click', takePhoto);
  retakeBtn?.addEventListener('click', retake);
  cowForm?.addEventListener('submit', handleSubmit);

  // Cleanup when page unloads
  window.addEventListener('beforeunload', stopCamera);

})();

  </script>
  
    
</body>
</html>